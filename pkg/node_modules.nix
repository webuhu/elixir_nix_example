{ stdenvNoCC, nodejs, hash ? null }:

stdenvNoCC.mkDerivation rec {
  __noChroot = if hash == null then true else false;
  name = "node_modules";
  package = ../assets/package.json;
  lockfile = ../assets/package-lock.json;
  buildInputs = [
    nodejs
  ];
  builder = builtins.toFile "builder.sh" ''
    source $stdenv/setup

    install $package package.json
    install $lockfile package-lock.json

    HOME=.
    npm ci --no-progress --no-fund --no-audit --no-update-notifier --loglevel error

    mkdir $out
    cp -r node_modules/. $out
  '';

  outputHashMode = "recursive";
  outputHash = hash;

  impureEnvVars = stdenvNoCC.lib.fetchers.proxyImpureEnvVars;
}
